Stack Watcher
===

[![CircleCI](https://circleci.com/gh/halfer/stackwatcher/tree/master.svg?style=svg)](https://circleci.com/gh/halfer/stackwatcher/tree/master)

Introduction
---

This project aims to do two things: it is first of all intended as a useful app to run search
queries on the Stack Overflow platform, in order to help volunteer editors keep track of
what needs editing. It is also an investigation into writing tests and using CI pipelines
in a Mongo Stitch application.

Build
---

The tests run in Docker. To build the image, issue this command:

    docker build -t stackwatcher .

During development, tests are run with a Docker volume on the project folder on the host. However,
using a volume obscures the node modules committed to the image, so they need to be copied to the
host. To do this, run the image without a volume to start with:

    docker run -dit stackwatcher

This will spin up a container and put it in the background. At the host console, the node
dependencies can be copied from the container to the host (the container name can be looked up
from `docker ps`):

    docker cp {container}:/root/node_modules .

Once that is successful, bring the container down:

    docker down {container}

Finally, start the image again, this time with a volume:

    docker run -v `pwd`:/root -it stackwatcher

Source compilation
---

The code is tested by a mixture of unit and database tests in Jest. The source code formats required
by Stitch and Jest are slightly different, viz:

```
// Stitch
exports = async function(query, userId) {

// Jest
module.exports = async function(query, userId) {
```

Code is written for Stitch, and a Bash script is used to copy-and-modify code before the tests are
run.

Tests
---

The tests can be run thus:

    sh bin/test-compile.sh && sh bin/run-tests.sh

Creating new functions
---

Each function needs a `config.json` file, which is generated by the Stitch platform. When a new
function is required I create it in the Stitch UI, do an export operation using the CLI utility, and
copy the JSON file from there to the project `functions` folder.

Console utility
---

The folks over at Mongo offer a [Stitch console utility](https://github.com/10gen/stitch-cli) to import/export
apps. Since I am cautious about running other people's code on my machines, I created a
[Docker version](https://github.com/halfer/docker-stitch-cli).

The following are Docker commands to authenticate to MongoDB Stitch.

To log in:

```
docker run --rm -it --volume=`echo $HOME`/.config/stitch:/root/.config/stitch stitch-cli login --username=youremail@example.com --api-key=01234567-abcd-efgh-ijkl-mnopqrstuvwx
```

Your logged-in status will be saved on your host, and will survive reboots.

To check you are logged in:

```
docker run --rm -it --volume=`echo $HOME`/.config/stitch:/root/.config/stitch stitch-cli whoami
```

Exporting the app
---

Here is how to deploy to Mongo Stitch. You need to be logged in for this:

```
docker run --rm -it --volume=`echo $HOME`/.config/stitch:/root/.config/stitch --volume=`pwd`:/project stitch-cli import --strategy=merge
```

Importing the app (deployment)
---

To refresh your local copy from Mongo Stitch, you can export instead. To be safe, ensure that you keep
everything under version control, and that your working directory is clear of local changes before
doing this. The export will happen in a sub-folder, and thus you need to copy and changes you wish to
keep from the export back to your local version.

```
docker run --rm -it --volume=`echo $HOME`/.config/stitch:/root/.config/stitch --volume=`pwd`/export:/export stitch-cli export --app-id=stackwatcher-prod-keysc --output /export/app
```
